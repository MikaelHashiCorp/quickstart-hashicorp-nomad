AWSTemplateFormatVersion: 2010-09-09
Description: "HashiCorp Nomad Security Group (Please do not remove) Aug,28,2019 (qs-1qup6ra8j)"
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: "Bastion host configuration"
        Parameters:
          - BastionSecurityGroupID
      - Label:
          default: "VPC Configuration"
        Parameters:
          - VPCID
          - VPCCIDR
          
Parameters:
  BastionSecurityGroupID:
    Description: ID of the bastion host security group to enable SSH connections (e.g., sg-7f16e910)
    Type: "AWS::EC2::SecurityGroup::Id"
  VPCID:
    Description: VPC ID
    Type: "AWS::EC2::VPC::Id"
  VPCCIDR:
    AllowedPattern: >-
      ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Description: CIDR block for the VPC
    Type: String 

Resources:
  NomadSecGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: "Enables SSH access."
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !Ref BastionSecurityGroupID
        - IpProtocol: tcp
          FromPort: 0
          ToPort: 65535
          CidrIp: !Ref VPCCIDR
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-NomadSecGroup"

Outputs:
  NomadSecGroup: !Ref NomadSecGroup
